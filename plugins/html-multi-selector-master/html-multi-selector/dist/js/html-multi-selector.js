(function(){var t=0,e=function(t){if("undefined"==typeof $)return void alert("HtmlMultiSelector require jQuery");var e={container:null,seperator:",",dynamic:!1,server:"/path/to/data",data:[],maxLevel:0,fixedLevel:0,lang:{close:"取消",done:"确定",pleaseSelect:"请选择"},callback:{change:function(t,e){},done:function(){},close:function(){}},selectorValue:"[data-value]",selectorTitle:"[data-title]",valueKey:"id",parentValueKey:"pid",titleKey:"title",sortKey:"sort",rootParentValue:0,optionItemHeightInEm:2,serverMethod:"get",serverDataType:"json",serverResponseHandle:function(t){return"object"!=typeof t?(alert("ErrorResponse:"+t),[]):"code"in t&&"data"in t?0!=t.code?(alert("ErrorResponseCode:"+t.code),[]):t.data:(alert("ErrorResponseObject:"+t.toString()),[])}};this.opt=$.extend(e,t),this.dom={container:$(this.opt.container),dialog:null,dialogItems:null},this.data={items:[],value:[],title:[]},this.opt.dynamic||(this.data.items=this.dataConvert(this.opt.data)),this.init()};e.prototype={init:function(){this.initDialog(),this.initEvent(),this.initValues()},initEvent:function(){var t=this,e="undefined"!=typeof window.document.ontouchstart,a=e?"touchstart":"mousedown",o=e?"touchend":"mouseup",i=e?"touchmove":"mousemove";this.dom.dialog.on(a,"[data-btn-close]",function(){return t.close(),!1}),this.dom.dialog.on(a,"[data-btn-done]",function(){return t.done(),!1});var n=null,l=0,d=0,s=0,r=0;this.dom.dialog.on(a,"[data-option-level]",function(a){d=e?a.originalEvent.targetTouches[0].clientY:a.clientY,n=$(this).find("[data-options]"),r=n.find("div").length;var o=parseFloat(n.css("top"));o||(o=0),s=$(this).find("[data-grid]").height()+2,l=o*t.opt.optionItemHeightInEm/s}),this.dom.dialog.on(i,document,function(a){if(a.preventDefault(),null!=n){var o,i,c,v;o=e?a.originalEvent.targetTouches[0].clientY:a.clientY,i=o-d,c=i*t.opt.optionItemHeightInEm/s,v=l+c,v<-(r-1)*t.opt.optionItemHeightInEm?n.css({top:-((r-1)*t.opt.optionItemHeightInEm)+"em"}):v>0?n.css({top:"0"}):n.css({top:v+"em"})}}),this.dom.dialog.on(o,document,function(e){if(null!=n){var a=parseFloat(n.css("top"));l=a*t.opt.optionItemHeightInEm/s,l=parseInt(l/t.opt.optionItemHeightInEm-.5)*t.opt.optionItemHeightInEm,n.animate({top:l+"em"});var o=-parseInt(l/t.opt.optionItemHeightInEm);n.find("[data-value]").removeAttr("data-selected"),$(n.find("[data-value]").get(o)).attr("data-selected",!0),t.dom.dialog.trigger("dialog.category.change",[n.closest("[data-option-level]")]),n=null}}),this.dom.dialog.on("dialog.category.change",function(e,a){var o=a.find("[data-options] > [data-selected]"),i=parseInt(a.attr("data-option-level")),n=o.attr("data-value");0==t.opt.maxLevel||i<t.opt.maxLevel?t.opt.dynamic?""==n?(t.renderClear(i+1),t.syncVal()):t.sendAsyncRequest(n,function(e){t.data.items=e,t.render(i+1,n),t.syncVal()}):(0==t.opt.maxLevel||i<t.opt.maxLevel)&&(""==n?(t.renderClear(i+1),t.syncVal()):(t.render(i+1,n),t.syncVal())):t.syncVal()})},initDialog:function(){var e="html-multi-selector-"+ ++t;if(this.dom.dialog=$(['<div class="html-multi-selector-container" id="',e,'">','   <div class="html-multi-selector-box html-multi-selector-slide-in-up">','       <div class="html-multi-selector-btn-box">','           <div class="html-multi-selector-btn" data-btn-close>',this.opt.lang.close,"</div>",'           <div class="html-multi-selector-btn" data-btn-done>',this.opt.lang.done,"</div>","       </div>",'       <div class="html-multi-selector-mask">','           <div class="html-multi-selector-roll" data-items>',"           </div>","       </div>","   </div>","</div>"].join("")),this.dom.dialog.appendTo("body"),this.dom.dialogItems=this.dom.dialog.find("[data-items]"),this.opt.fixedLevel>0)for(var a=0;a<this.opt.fixedLevel;a++)this.setLevelOption(a+1,[])},initValues:function(){var t=this,e=[],a=[];if(this.dom.container.length){var o,i=this.dom.container.find(this.opt.selectorValue).val();if(i){o=i.split(this.opt.seperator);for(var n=0;n<o.length;n++)o[n]&&e.push(o[n])}else{i=this.dom.container.find(this.opt.selectorTitle).val(),o=i.split(this.opt.seperator);for(var n=0;n<o.length;n++)o[n]&&a.push(o[n])}}this.opt.dynamic&&e.length?this.val(e):this.opt.dynamic&&a.length?this.titleVal(a):this.opt.dynamic?this.sendAsyncRequest(0,function(e){t.data.items=e,t.render(1,t.opt.rootParentValue)}):e.length?this.val(e):a.length?this.titleVal(a):t.render(1,t.opt.rootParentValue)},sendAsyncRequest:function(t,e,a){a=a||null;var o={},i=this,n=this.opt.sortKey;o[this.opt.parentValueKey]=t,o[this.opt.titleKey]=a,$.ajax({type:this.opt.serverMethod,url:this.opt.server,dataType:this.opt.serverDataType,timeout:3e4,data:o,success:function(t){var a=i.opt.serverResponseHandle(t);a.sort(function(t,e){return t[n]-e[n]});var o=i.dataConvert(t.data);e(o)},error:function(){alert("请求出现错误 T_T")}})},dataConvert:function(t){for(var e=this,a=[],o=0;o<t.length;o++)a.push({parentValue:t[o][e.opt.parentValueKey],value:t[o][e.opt.valueKey],title:t[o][e.opt.titleKey]});return a},render:function(t,e){var a=this;this.dom.dialogItems.find("[data-option-level]").each(function(e,o){var i=parseInt($(o).attr("data-option-level"));i>=t&&(t>1?a.opt.fixedLevel?$(o).find("[data-options]").html("").css("top",0):$(o).remove():$(o).find("[data-options]").html("").css("top",0))});for(var o=[],i=this.data.items,n=0;n<i.length;n++)i[n].parentValue==e&&o.push({value:i[n].value,title:i[n].title});o.length&&this.setLevelOption(t,o)},renderClear:function(t){var e=this;this.dom.dialogItems.find("[data-option-level]").each(function(a,o){var i=parseInt($(o).attr("data-option-level"));i>=t&&(e.opt.fixedLevel?$(o).find("[data-options]").html("").css("top",0):$(o).remove())})},setLevelOption:function(t,e){var a=this.dom.dialogItems.find("[data-option-level="+t+"]");a.length||(a=$(['<div data-option-level="',t,'">','   <div class="html-multi-selector-gallery" data-options></div>','   <div class="html-multi-selector-grid" data-grid></div>',"</div>"].join("")),this.dom.dialogItems.append(a));var o=[];o.push('<div data-value="">'+this.opt.lang.pleaseSelect+"</div>");for(var i=0;i<e.length;i++)o.push('<div data-value="'+e[i].value+'">'+e[i].title+"</div>");a.find("[data-options]").html(o.join(""))},getLevelValue:function(t){var e=this.dom.dialogItems.find("[data-option-level="+t+"]");if(!e.length)return null;var a=e.find("[data-options]"),o=a.find("[data-value][data-selected]");return o.length?o.attr("data-value"):null},setLevelValue:function(t,e){var a=this.dom.dialogItems.find("[data-option-level="+t+"]");if(a.length){var o=a.find("[data-options]"),i=o.find('[data-value="'+e+'"]');if(i.length){var n=o.find("[data-value]").index(i);o.find("[data-value]").removeAttr("data-selected"),$(o.find("[data-value]").get(n)).attr("data-selected",!0),o.css({top:-(n*this.opt.optionItemHeightInEm)+"em"})}}},setLevelTitle:function(t,e){var a=this.dom.dialogItems.find("[data-option-level="+t+"]");if(a.length){var o=a.find("[data-options]"),i=null;if(o.find("[data-value]").each(function(t,a){$(a).text()==e&&(i=$(a))}),i){var n=o.find("[data-value]").index(i);o.find("[data-value]").removeAttr("data-selected"),$(o.find("[data-value]").get(n)).attr("data-selected",!0),o.css({top:-(n*this.opt.optionItemHeightInEm)+"em"})}}},close:function(){this.dom.dialog.hide(),this.opt.callback.close&&this.opt.callback.close.call(this)},open:function(){this.dom.dialog.show()},done:function(){this.dom.dialog.hide(),this.opt.callback.done&&this.opt.callback.done.call(this)},val:function(t){var e=this;if(void 0==t)return e.data.value;var a=t;if(!a.length)return void e.render(1,e.opt.rootParentValue);var o=function(){e.render(1,e.opt.rootParentValue);for(var t=0;t<a.length;t++){var o=t+1,i=a[t];e.setLevelValue(o,i),(0==e.opt.maxLevel||o+1<=e.opt.maxLevel)&&e.render(o+1,i)}e.syncVal()};if(e.opt.dynamic){var i=[e.opt.rootParentValue];i=i.concat(a),e.sendAsyncRequest(i.join(e.opt.seperator),function(t){e.data.items=t,o()})}else o()},titleVal:function(t){var e=this;if(void 0==t)return e.data.title;var a=t;if(!a.length)return void e.render(1,e.opt.rootParentValue);var o=function(){e.render(1,e.opt.rootParentValue);for(var t=0;t<a.length;t++){var o=t+1,i=a[t];e.setLevelTitle(o,i),(0==e.opt.maxLevel||o+1<=e.opt.maxLevel)&&e.render(o+1,e.getLevelValue(o))}e.syncVal()};e.opt.dynamic?e.sendAsyncRequest(null,function(t){e.data.items=t,o()},a.join(e.opt.seperator)):o()},syncVal:function(){var t=this;t.dom.container.find("[data-value]").val(""),t.dom.container.find("[data-title]").val("");var e=[],a=[];t.dom.dialogItems.find("[data-option-level]").each(function(t,o){var i=$(o).find("[data-value][data-selected]"),n=i.attr("data-value");n&&(e.push(n),a.push(i.html()))}),t.data.value=e,t.data.title=a,t.dom.container.find("[data-value]").each(function(a,o){var i=$(o).attr("data-for-level");i?(i=parseInt(i),i<=e.length&&$(o).val(e[i-1])):$(o).val(e.join(t.opt.seperator))}),t.dom.container.find("[data-title]").each(function(e,o){var i=$(o).attr("data-for-level");i?(i=parseInt(i),i<=a.length&&$(o).val(a[i-1])):$(o).val(a.join(t.opt.seperator))}),t.opt.callback.change&&t.opt.callback.change.call(this,e,a)}},"undefined"!=typeof module&&"object"==typeof exports&&define.cmd?module.exports=e:"function"==typeof define&&define.amd?define(function(){return e}):this.HtmlMultiSelector=e}).call(function(){return this||("undefined"!=typeof window?window:global)}());